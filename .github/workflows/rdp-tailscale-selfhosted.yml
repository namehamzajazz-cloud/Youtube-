name: üñ•Ô∏è RDP + üåê Tailscale (Self-Hosted Safe Version)

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Your Tailscale auth key (from https://login.tailscale.com/admin/settings/keys)"
        required: true

jobs:
  setup:
    runs-on: self-hosted  # ‚úÖ your own machine, not GitHub's servers
    steps:
      - name: üé® Setup RDP User and Auto-Launch Browser
        shell: powershell
        run: |
          $esc = [char]27
          function ColorEcho($colorCode, $text) {
            Write-Host "$esc[$colorCode""m$text$esc[0m"
          }

          $user = "HamzaEditz"
          $password = "Hamza@12345"
          $youtubeUrl = "https://www.youtube.com/@hamzashafiq786"

          ColorEcho "96" "üîß Creating or updating RDP user..."
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          if (Get-LocalUser -Name $user -ErrorAction SilentlyContinue) {
              Set-LocalUser -Name $user -Password $securePassword
          } else {
              New-LocalUser -Name $user -Password $securePassword -FullName "Hamza Editz" -Description "Temporary RDP user"
          }

          Add-LocalGroupMember -Group "Administrators" -Member $user
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user

          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          ColorEcho "92" "‚úÖ RDP enabled for user '$user'."

          # Add a startup script that opens Edge and YouTube on login
          $startupFolder = "C:\Users\$user\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
          if (!(Test-Path $startupFolder)) { New-Item -ItemType Directory -Force -Path $startupFolder | Out-Null }
          $shortcutPath = "$startupFolder\OpenYouTube.lnk"

          $shell = New-Object -ComObject WScript.Shell
          $edgePath = (Get-Item "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe").FullName
          $shortcut = $shell.CreateShortcut($shortcutPath)
          $shortcut.TargetPath = $edgePath
          $shortcut.Arguments = $youtubeUrl
          $shortcut.Description = "Auto open YouTube on login"
          $shortcut.Save()

          ColorEcho "92" "üåê Browser auto-launch configured!"
          ColorEcho "97" "üëâ When '$user' logs in via RDP, Edge will open and load: $youtubeUrl"

      - name: üåê Connect to Tailscale
        shell: powershell
        run: |
          $esc = [char]27
          function ColorEcho($colorCode, $text) {
            Write-Host "$esc[$colorCode""m$text$esc[0m"
          }

          ColorEcho "96" "Installing or updating Tailscale..."
          if (!(Get-Command tailscale -ErrorAction SilentlyContinue)) {
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup.exe"
              Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/quiet" -Wait
          }

          ts up --authkey "${{ github.event.inputs.ts_authkey }}" --hostname "HamzaServer" --accept-dns=true --accept-routes=true
          $ip = ts ip -4
          ColorEcho "92" "‚úÖ Tailscale connected successfully!"
          ColorEcho "97" "Your Tailscale IP: $ip"
